# E2E тест авторизации через SMS - STO-30

## Задача
Создать E2E тест полного флоу авторизации администратора через SMS с использованием Playwright.

## Что сделано

### 1. Конфигурация Playwright
- ✅ Создан файл `playwright.config.ts` с настройками для запуска тестов
- ✅ Настроены три браузера для тестирования: Chromium, Firefox, WebKit
- ✅ Настроен автоматический запуск dev-сервера перед тестами
- ✅ Добавлены настройки для CI/CD окружения

### 2. E2E тест авторизации (`e2e/auth.spec.ts`)
Реализованы следующие тест-кейсы:

#### Основной сценарий
- ✅ `should successfully authenticate admin user via SMS` - полный флоу авторизации:
  - Открытие страницы входа
  - Ввод номера телефона
  - Переход на страницу ввода кода
  - Ввод SMS кода
  - Проверка успешного входа в систему
  - Проверка сохранения сессии после перезагрузки страницы

#### Валидация
- ✅ `should show error for invalid phone number` - проверка валидации неполного номера
- ✅ `should show error for invalid SMS code` - проверка ошибки при неверном коде

#### Дополнительные сценарии
- ✅ `should allow code resend after timeout` - проверка функционала повторной отправки кода
- ✅ `should redirect to login page when accessing protected route without auth` - проверка редиректа
- ✅ `should handle Enter key press on phone input` - обработка клавиши Enter

### 3. Вспомогательные файлы
- ✅ `e2e/helpers.ts` - утилиты для тестов:
  - Функция авторизации для использования в других тестах
  - Функция очистки данных авторизации
  - Функция проверки авторизации
  - Функция ожидания toast-уведомлений
  - Константы с тестовыми данными и роутами

### 4. Улучшение тестируемости компонентов
Добавлены `data-testid` атрибуты в компоненты:
- ✅ `AuthPhonePage` - `data-testid="auth-phone-page"`
- ✅ Инпут телефона - `data-testid="phone-input"`
- ✅ Кнопка отправки телефона - `data-testid="submit-phone-button"`
- ✅ `AuthCodePage` - `data-testid="auth-code-page"`
- ✅ Инпут кода - `data-testid="code-input"`
- ✅ Кнопка повторной отправки - `data-testid="resend-code-button"`
- ✅ Кнопка отправки кода - `data-testid="submit-code-button"`

### 5. Скрипты для запуска тестов
Добавлены в `package.json`:
```json
{
  "test:e2e": "playwright test",
  "test:e2e:ui": "playwright test --ui",
  "test:e2e:headed": "playwright test --headed",
  "test:e2e:debug": "playwright test --debug",
  "test:e2e:report": "playwright show-report"
}
```

### 6. Документация
- ✅ `e2e/README.md` - подробная документация по E2E тестам:
  - Описание структуры
  - Инструкции по запуску
  - Описание всех тест-кейсов
  - Настройка переменных окружения
  - Лучшие практики
  - Отладка тестов

### 7. Переменные окружения
- ✅ `.env.e2e` - конфигурация для тестов:
  - Тестовый номер телефона
  - Тестовый SMS код
  - URL приложения и API
  - Таймауты

### 8. Git конфигурация
- ✅ Обновлен `.gitignore` для исключения артефактов Playwright:
  - `/test-results/`
  - `/playwright-report/`
  - `/blob-report/`
  - `/playwright/.cache/`

## Структура файлов
```
e2e/
├── auth.spec.ts       # Тесты авторизации через SMS
├── helpers.ts         # Вспомогательные функции и константы
└── README.md          # Документация по E2E тестам

playwright.config.ts   # Конфигурация Playwright
.env.e2e              # Переменные окружения для тестов
```

## Запуск тестов

### Установка браузеров (первый раз)
```bash
npx playwright install
```

### Запуск всех тестов
```bash
pnpm test:e2e
```

### Запуск с UI интерфейсом
```bash
pnpm test:e2e:ui
```

### Запуск с отображением браузера
```bash
pnpm test:e2e:headed
```

### Режим отладки
```bash
pnpm test:e2e:debug
```

### Просмотр отчета
```bash
pnpm test:e2e:report
```

## Требования к бэкенду для тестов

Для корректной работы E2E тестов необходимо настроить на бэкенде:

1. **Тестовый номер телефона**: `+79999999999`
2. **Фиксированный SMS код**: `1234` (для тестового номера)
3. **Отключение реальной отправки SMS** для тестовых номеров

## Покрытие тестами

### Авторизация
- ✅ Полный флоу авторизации через SMS
- ✅ Валидация номера телефона
- ✅ Валидация SMS кода
- ✅ Повторная отправка кода
- ✅ Сохранение сессии
- ✅ Редирект на защищенные страницы
- ✅ Обработка клавиатурных событий

### Покрытие компонентов
- ✅ AuthPhonePage
- ✅ AuthCodePage
- ✅ AppPhoneInput
- ✅ AppCodeInput
- ✅ AppButton

## Следующие шаги

1. Установить браузеры Playwright: `npx playwright install`
2. Настроить тестовое окружение на бэкенде
3. Запустить тесты локально для проверки
4. Интегрировать запуск тестов в CI/CD pipeline
5. По необходимости добавить дополнительные E2E тесты для других страниц

## Особенности реализации

1. **Изоляция тестов**: Каждый тест начинается с очистки cookies и localStorage
2. **Автоматический запуск dev-сервера**: Playwright сам запускает приложение перед тестами
3. **Мультибраузерное тестирование**: Тесты запускаются в трех браузерах
4. **Автоматические скриншоты**: При падении теста создаются скриншоты и trace-файлы
5. **Data-testid селекторы**: Использование стабильных селекторов для элементов

## Полезные команды

```bash
# Запуск конкретного теста
pnpm test:e2e auth.spec.ts

# Запуск в конкретном браузере
pnpm test:e2e --project=chromium

# Запуск с генерацией кода теста
npx playwright codegen http://localhost:5173

# Просмотр trace файла
npx playwright show-trace trace.zip
```

## Статус задачи

✅ **Готово к тестированию**

Все требования из задачи выполнены. E2E тест покрывает полный флоу авторизации администратора через SMS, включая все указанные сценарии и дополнительные проверки валидации и edge-cases.
