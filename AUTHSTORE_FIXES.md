# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è AuthStore

## –î–∞—Ç–∞: 20 –¥–µ–∫–∞–±—Ä—è 2025 –≥.

## –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ:

1. **Race Condition –≤ refreshTokens()**
   - –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ `OpenAPI.TOKEN` –Ω–∞ refresh token —Å–æ–∑–¥–∞–≤–∞–ª–æ –ø—Ä–æ–±–ª–µ–º—É, –∫–æ–≥–¥–∞ –¥—Ä—É–≥–∏–µ API –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å refresh token –≤–º–µ—Å—Ç–æ access token

2. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤**
   - –°—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–æ 2 –º–µ—Ö–∞–Ω–∏–∑–º–∞: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∞–π–º–µ—Ä + interceptor
   - –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –∏–∑–±—ã—Ç–æ—á–Ω—ã–º –∑–∞–ø—Ä–æ—Å–∞–º

3. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π**
   - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≥–æ–≤–æ—Ä–∏–ª "–æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞ 10 –º–∏–Ω—É—Ç –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è", –Ω–æ –∫–æ–¥ –æ–±–Ω–æ–≤–ª—è–ª "—á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç"

4. **–†–∞–∑–ª–æ–≥–∏–Ω –ø—Ä–∏ –ª—é–±—ã—Ö –æ—à–∏–±–∫–∞—Ö**
   - –ü—Ä–∏ network –æ—à–∏–±–∫–∞—Ö –∏–ª–∏ 500 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–ª–æ, —Ö–æ—Ç—è —Ç–æ–∫–µ–Ω—ã –º–æ–≥–ª–∏ –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º–∏

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### ‚úÖ AuthStore.ts

1. **–£–¥–∞–ª–µ–Ω —Ç–∞–π–º–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**
   - –£–±—Ä–∞–Ω–æ –ø–æ–ª–µ `refreshTimer`
   - –£–¥–∞–ª–µ–Ω –º–µ—Ç–æ–¥ `setupTokenRefresh()`
   - –£–±—Ä–∞–Ω—ã –≤—Å–µ –≤—ã–∑–æ–≤—ã `setupTokenRefresh()`
   - –¢–µ–ø–µ—Ä—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ interceptor –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ 401

2. **–ü–µ—Ä–µ–ø–∏—Å–∞–Ω –º–µ—Ç–æ–¥ refreshTokens()**
   ```typescript
   // –ë–´–õ–û: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ authRefresh() —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º OpenAPI.TOKEN
   OpenAPI.TOKEN = this.refreshToken;
   const response = await authRefresh();
   
   // –°–¢–ê–õ–û: –ø—Ä—è–º–æ–π axios –∑–∞–ø—Ä–æ—Å —Å —è–≤–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–µ–π refresh token
   const response = await axios.post<AuthRefreshResponse>(
     `${OpenAPI.BASE}/api/auth/refresh`,
     {},
     {
       headers: {
         Authorization: `Bearer ${this.refreshToken}`,
       },
     }
   );
   ```

3. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –æ—à–∏–±–∫–∏ –ø–µ—Ä–µ–¥ logout**
   ```typescript
   // –†–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ 401 –æ—à–∏–±–∫–µ (–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π/–∏—Å—Ç–µ–∫—à–∏–π refresh token)
   // –ü—Ä–∏ network –æ—à–∏–±–∫–∞—Ö –Ω–µ —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   if (axios.isAxiosError(error) && error.response?.status === 401) {
     this.logout();
   }
   ```

4. **–£–ø—Ä–æ—â–µ–Ω –º–µ—Ç–æ–¥ logout()**
   - –£–±—Ä–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ç–∞–π–º–µ—Ä–∞
   - –ú–µ—Ç–æ–¥ —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –æ—á–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### ‚úÖ AuthStore.test.ts

1. **–î–æ–±–∞–≤–ª–µ–Ω mock –¥–ª—è axios**
   - –ú–æ–∫–∏—Ä—É—é—Ç—Å—è –º–µ—Ç–æ–¥—ã `axios.post` –∏ `axios.isAxiosError`

2. **–£–¥–∞–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**
   - –£–±—Ä–∞–Ω—ã —Ç–µ—Å—Ç—ã –¥–ª—è `setupTokenRefresh()`
   - –£–±—Ä–∞–Ω—ã —Ç–µ—Å—Ç—ã —Å fake timers –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

3. **–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è refreshTokens()**
   - ‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ refresh token –≤ Authorization header
   - ‚úÖ Logout —Ç–æ–ª—å–∫–æ –ø—Ä–∏ 401 –æ—à–∏–±–∫–µ
   - ‚úÖ –ù–ï logout –ø—Ä–∏ network –æ—à–∏–±–∫–µ
   - ‚úÖ –ù–ï logout –ø—Ä–∏ 500 –æ—à–∏–±–∫–µ
   - ‚úÖ Logout –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ refresh token

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –¢–µ—Å—Ç—ã
- ‚úÖ 18/18 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ (–±—ã–ª–æ 19, —É–±—Ä–∞–Ω 1 —Ç–µ—Å—Ç —Ç–∞–π–º–µ—Ä–∞)
- ‚úÖ 100% –ø–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
- ‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤ TypeScript –ø—Ä–æ—Ö–æ–¥—è—Ç

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

1. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**
   - –ù–µ—Ç race condition —Å `OpenAPI.TOKEN`
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Å–µ—Ç—å—é
   - –¢–æ–ª—å–∫–æ interceptor —É–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–æ–≤

2. **–ü—Ä–æ—Å—Ç–æ—Ç–∞**
   - –£–±—Ä–∞–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è –ª–æ–≥–∏–∫–∞ —Ç–∞–π–º–µ—Ä–∞
   - –ú–µ–Ω—å—à–µ –∫–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å
   - –ü—Ä–æ—â–µ –ø–æ–Ω—è—Ç—å –ø–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç—ã

3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
   - –ù–µ—Ç –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ refresh
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ (–ø—Ä–∏ 401)

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–∞–±–æ—Ç—ã —Å —Ç–æ–∫–µ–Ω–∞–º–∏

```
1. Login ‚Üí –ø–æ–ª—É—á–µ–Ω–∏–µ access + refresh —Ç–æ–∫–µ–Ω–æ–≤
2. API –∑–∞–ø—Ä–æ—Å ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç access token
3. –ü–æ–ª—É—á–µ–Ω–∏–µ 401 ‚Üí interceptor –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç
4. refreshTokens() ‚Üí –ø—Ä—è–º–æ–π axios –∑–∞–ø—Ä–æ—Å —Å refresh token
5. –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ ‚Üí –ø–æ–≤—Ç–æ—Ä –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
```

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã:
- API –∫–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
- –ü—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã AuthStore –æ—Å—Ç–∞–ª–∏—Å—å —Ç–µ –∂–µ
- –ü–æ–≤–µ–¥–µ–Ω–∏–µ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
- Interceptor (`setupApiInterceptors`) —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ
