# Тесты AuthStore

## Описание

Unit-тесты для AuthStore - store, управляющего аутентификацией администраторов через SMS.

## Покрытие

- ✅ Отправка SMS кода (sendCode)
- ✅ Верификация кода (verifyCode)
- ✅ Автоматическое обновление токенов (refreshTokens)
- ✅ Выход из системы (logout)
- ✅ Восстановление сессии из localStorage
- ✅ Обработка ошибок

## Технологии

- **Vitest** - test runner
- **jsdom** - DOM environment для тестов
- **Vi Mock** - мокирование модулей и функций

## Запуск тестов

```bash
# Запустить все тесты
pnpm test

# Запустить тесты в watch режиме
pnpm test

# Запустить тесты с coverage
pnpm test:coverage

# Запустить тесты с UI
pnpm test:ui
```

## Структура тестов

### Initialization
- Проверка инициализации с дефолтными значениями
- Восстановление сессии из localStorage
- Обработка поврежденных данных в localStorage

### sendCode
- Успешная отправка SMS кода
- Обработка ошибок отправки
- Управление состоянием isLoading

### verifyCode
- Успешная верификация и вход
- Обработка ошибок верификации
- Управление состоянием isLoading
- Сохранение данных в localStorage
- Инициализация уведомлений

### refreshTokens
- Успешное обновление токенов
- Установка refresh token перед запросом
- Выход при ошибке обновления
- Выход при отсутствии refresh token

### Automatic token refresh
- Настройка автоматического обновления после входа
- Очистка таймера при выходе

### logout
- Очистка всех данных авторизации
- Остановка таймера автообновления

### Error handling
- Обработка ошибок инициализации уведомлений
- Обработка ошибок при восстановлении сессии

## Текущее покрытие

```
--------------|---------|----------|---------|---------|-------------------
File          | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
--------------|---------|----------|---------|---------|-------------------
All files     |     100 |      100 |     100 |     100 |                   
 AuthStore.ts |     100 |      100 |     100 |     100 |                   
--------------|---------|----------|---------|---------|-------------------
```

## Моки

Тесты используют моки для:
- `adminAuthSendCode` - отправка SMS кода
- `adminAuthLogin` - вход по коду
- `authRefresh` - обновление токенов
- `OpenAPI.TOKEN` - глобальный токен для API
- `toastStore.showError` - показ ошибок
- `notificationService.initialize` - инициализация уведомлений
- `localStorage` - хранилище браузера

## Особенности реализации

1. **Fake Timers** - используются для тестирования автоматического обновления токенов
2. **MobX** - тестируются observable свойства и actions
3. **Async/Await** - все асинхронные операции корректно обрабатываются
4. **Cleanup** - каждый тест очищает состояние перед запуском
