# Исправление проблемы с push-уведомлениями

## Проблема
На стейдже Firebase Service Worker не запускался автоматически при открытии сайта. Service Worker появлялся только после ручного включения/выключения уведомлений в настройках.

## Причины
1. **Service Worker не регистрировался при старте приложения** - регистрация происходила только при ручном включении уведомлений
2. **Отсутствовала инициализация после авторизации** - уведомления не инициализировались автоматически после входа пользователя
3. **Неправильная конфигурация в Service Worker** - в `firebase-messaging-sw.js` были заглушки вместо реальных Firebase credentials

## Что исправлено

### 1. Автоматическая инициализация Firebase (`src/main.tsx`)
- Добавлен вызов `initializeFirebase()` при старте приложения
- Firebase теперь инициализируется всегда, независимо от состояния авторизации

### 2. Автоматическая инициализация уведомлений (`src/stores/AuthStore.ts`)
- После успешной авторизации (`verifyCode`) автоматически вызывается `notificationService.initialize()`
- При восстановлении сессии из localStorage (`checkAuth`) также вызывается инициализация уведомлений
- Это гарантирует, что Service Worker зарегистрируется сразу после входа пользователя

### 3. Улучшенная логика Service Worker (`src/services/notificationService.ts`)
- Добавлен отдельный метод `registerServiceWorker()` для регистрации SW
- Метод `initialize()` теперь всегда регистрирует Service Worker, даже если:
  - Уведомления отключены в настройках
  - Пользователь еще не дал разрешение
  - Это позволяет принимать фоновые уведомления всегда
- Метод `getToken()` использует существующую регистрацию SW или создает новую
- Service Worker теперь готов принимать фоновые уведомления сразу после авторизации

### 4. Корректная конфигурация Firebase (`public/firebase-messaging-sw.js`)
- Заменены заглушки (`YOUR_API_KEY`, etc.) на реальные значения из `.env`
- Конфигурация теперь соответствует Firebase проекту `prosto-b13d3`
- Service Worker корректно инициализирует Firebase Messaging

## Как проверить

### Локально:
1. Очистить кэш браузера и Service Workers
2. Открыть приложение
3. Авторизоваться
4. Открыть DevTools → Application → Service Workers
5. **Service Worker должен быть зарегистрирован автоматически**
6. Проверить консоль на наличие сообщения: `Firebase initialized successfully`
7. После авторизации должны появиться логи инициализации уведомлений

### На стейдже:
1. Очистить кэш и Service Workers
2. Открыть https://dev.prosto-app.ru/ (или адрес стейджа)
3. Авторизоваться
4. **Service Worker должен появиться сразу после авторизации**
5. Перейти в Настройки → Уведомления
6. Включить уведомления (будет запрошено разрешение браузера)
7. После предоставления разрешения токен должен быть отправлен на сервер

## Ожидаемое поведение

### До исправления:
- ❌ Service Worker не регистрируется при старте
- ❌ Service Worker появляется только при ручном включении уведомлений
- ❌ Фоновые уведомления не работают до первого визита в настройки

### После исправления:
- ✅ Firebase инициализируется при старте приложения
- ✅ Service Worker регистрируется автоматически после авторизации
- ✅ Фоновые уведомления работают сразу (если пользователь дал разрешение ранее)
- ✅ При включении уведомлений в настройках токен отправляется на сервер
- ✅ При отключении уведомлений токен удаляется с сервера, но SW остается зарегистрированным

## Технические детали

### Последовательность инициализации:
1. `main.tsx` → `initializeFirebase()` - инициализация Firebase app
2. Пользователь авторизуется
3. `AuthStore.verifyCode()` или `AuthStore.checkAuth()` → `notificationService.initialize()`
4. `notificationService.initialize()`:
   - Регистрирует Service Worker
   - Проверяет настройки на сервере
   - Если уведомления включены И есть разрешение браузера:
     - Получает FCM токен
     - Отправляет токен на сервер
     - Настраивает обработчики сообщений

### Файлы изменены:
- `src/main.tsx` - добавлена инициализация Firebase
- `src/stores/AuthStore.ts` - добавлена автоматическая инициализация уведомлений
- `src/services/notificationService.ts` - улучшена логика регистрации SW
- `public/firebase-messaging-sw.js` - исправлена конфигурация Firebase

## Логи для проверки

В консоли браузера должны появиться следующие сообщения:

```
Firebase initialized successfully
Notifications are not supported, skipping initialization  // Если не авторизован
Service Worker registered successfully: ServiceWorkerRegistration {...}
Notification settings loaded from server
Notifications are disabled in settings, Service Worker registered but tokens not requested  // Если уведомления отключены
```

Если уведомления включены и разрешение получено:
```
FCM Token received: <token>
Token successfully sent to server
Notification service initialized successfully
```
