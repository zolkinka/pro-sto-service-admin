# ViewBookingModal

Компонент для просмотра информации о бронировании автоуслуг.

## Описание

`ViewBookingModal` - это модальное окно только для чтения, которое отображает детальную информацию о бронировании. Компонент открывается при клике на карточку бронирования в календаре и заменяет предыдущую форму редактирования (`EditBookingModal`).

## Основные возможности

- Отображение информации об автомобиле (марка, модель, госномер)
- Умное отображение автомобиля:
  - Если доступно изображение (`generated_image`) - показывается фото автомобиля
  - Изображения загружаются с учетом `VITE_BASE_STATIC_PATH` из переменных окружения
  - Если изображения нет - отображается стилизованный placeholder с иконкой
- Показ статуса бронирования с цветовой индикацией
- Список услуг с длительностью и ценой
- Отображение комментария клиента к заказу (если указан)
- Возможность отмены записи с подтверждением
- Блокировка скролла при открытии
- Состояния загрузки и ошибок

## Props

```typescript
interface ViewBookingModalProps {
  isOpen: boolean;        // Флаг открытия/закрытия модального окна
  onClose: () => void;    // Callback при закрытии окна
  bookingUuid: string;    // UUID бронирования для загрузки деталей
  onUpdate: () => void;   // Callback после успешной отмены заказа
}
```

## Использование

```tsx
import ViewBookingModal from '@/pages/OrdersPage/components/ViewBookingModal';

function OrdersPage() {
  const [selectedBooking, setSelectedBooking] = useState<string | null>(null);

  const handleBookingClick = (bookingUuid: string) => {
    setSelectedBooking(bookingUuid);
  };

  const handleCloseModal = () => {
    setSelectedBooking(null);
  };

  const handleUpdateBooking = () => {
    // Перезагрузить список бронирований
    bookingsStore.fetchBookings();
  };

  return (
    <div>
      {selectedBooking && (
        <ViewBookingModal
          isOpen={selectedBooking !== null}
          onClose={handleCloseModal}
          bookingUuid={selectedBooking}
          onUpdate={handleUpdateBooking}
        />
      )}
    </div>
  );
}
```

## Статусы бронирования

Компонент поддерживает следующие статусы с соответствующими цветами:

- `pending_confirmation` - Желтый тег "Ожидает"
- `confirmed` - Синий тег "Подтвержден"
- `completed` - Зеленый тег "Завершено"
- `cancelled` - Красный тег "Отменён"

## Функциональность

### Загрузка данных

При открытии модального окна автоматически загружаются детали бронирования через `bookingsStore.fetchBookingDetails(bookingUuid)`.

### Отмена записи

Кнопка "Отменить запись" доступна только для статусов, отличных от `cancelled` и `completed`. При клике показывается системное подтверждение, после чего выполняется запрос на изменение статуса.

### Блокировка скролла

При открытии модального окна автоматически блокируется скролл основной страницы, а при закрытии восстанавливается.

## Зависимости

- `mobx-react-lite` - для реактивности через observer
- `date-fns` - для форматирования дат и времени
- `@/components/ui/AppTag` - компонент тега для отображения статуса
- `@/stores/BookingsStore` - MobX store для работы с бронированиями
- `@/hooks/useStores` - хук для доступа к stores

## Стилизация

Компонент использует CSS модули (`ViewBookingModal.css`) со следующими ключевыми характеристиками:

- Ширина: 346px
- Абсолютное позиционирование справа от календаря
- Скругление: 24px
- Цвета из дизайн-системы проекта (gray/*)
- Шрифт: Onest (Regular для текста, Medium для заголовков)

## Storybook

Компонент имеет полный набор сториз для всех состояний:

- `Default` - открытое окно со статусом "Подтвержден"
- `Closed` - закрытое модальное окно
- `PendingStatus` - статус "Ожидает"
- `CompletedStatus` - статус "Завершено"
- `CancelledStatus` - статус "Отменён"
- `WithAdditionalServices` - с дополнительными услугами
- `Loading` - состояние загрузки
- `NewBooking` - режим новой записи с кнопкой "Подтвердить"
- `NewBookingWithCounter` - новая запись со счетчиком (1 из 3)
- `WithCarImage` - бронирование с изображением автомобиля
- `WithoutCarImage` - бронирование без изображения (placeholder)
- `WithStringLicensePlate` - номер автомобиля в строковом формате
- `WithComment` - бронирование с комментарием клиента

## Типы данных

Компонент использует следующие типы из API:

- `DetailedBookingResponseDto` - полная информация о бронировании
- `BookingCarDto` - информация об автомобиле
  - **Примечание о `license_plate`**: Поле может иметь два формата:
    - Объект `{ number?: string; region?: string }` - для раздельного отображения номера и региона
    - Строка `string` - полный номер целиком (используется в `AdminBookingCarDto`)
  - **Примечание о `generated_image`**: В runtime может присутствовать дополнительное поле `generated_image` (string | null), которое содержит URL сгенерированного изображения автомобиля. Хотя это поле отсутствует в типе `BookingCarDto`, оно присутствует в `AdminBookingCarDto` и может приходить с сервера.
- `BookingServiceDto` - информация об услуге
- `BookingStatus` - тип статуса бронирования
- `client_comment` - комментарий клиента к заказу
  - **Примечание о типе**: В API типизирован как `{ [key: string]: unknown; } | null`, но на практике приходит строка или null. Компонент корректно обрабатывает оба варианта.

## Форматирование

### Дата и время
Формат: "25 сентября, 19:30-20:30"

### Госномер
Формат зависит от типа данных:
- Объект: "A000AA | 111" (номер + разделитель + регион)
- Строка: "А123ВС 77" (как есть из API)
- Если не указан: "Не указан"

### Услуги
Формат: "Название • Длительность • Цена" (с точками-разделителями)

### Длительность
- Менее 60 минут: "40 мин"
- Более 60 минут: "1 ч 30 мин"
- Ровное количество часов: "2 ч"

## Обработка ошибок

- При ошибке загрузки данных показывается сообщение "Не удалось загрузить информацию о бронировании"
- При ошибке отмены заказа показывается toast-уведомление через `ToastStore`
- Все ошибки логируются в консоль

## Ограничения

- Компонент только для просмотра, редактирование не поддерживается
- Единственное доступное действие - отмена записи
- Изменение статуса доступно только на "cancelled"
