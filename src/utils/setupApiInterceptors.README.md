# API Interceptors - Автоматическое обновление токенов

## Описание

Модуль `setupApiInterceptors` настраивает глобальный перехватчик для axios, который автоматически обрабатывает 401 ошибки и пытается обновить access token с помощью refresh token.

## Проблема которую решает

**До внедрения:**
- При истечении access token любой API запрос возвращал 401
- Приложение показывало toast с ошибкой
- Пользователь оставался авторизованным, но не мог работать с API
- Требовался повторный вход

**После внедрения:**
- При получении 401 автоматически пытаемся обновить токен
- Если refresh успешен - пользователь не замечает перебоя
- Если refresh неуспешен - автоматически разлогиниваем
- Пользователь получает бесшовный опыт работы

## Как это работает

### Логика работы:

1. **При получении 401 ошибки:**
   - Проверяется, что это не запрос на авторизацию (`/auth/login`, `/auth/send-code`, `/auth/refresh`)
   - Если уже идет процесс обновления токена - запрос добавляется в очередь
   - Если нет - инициируется процесс обновления токена

2. **Обновление токена:**
   - Вызывается `authStore.refreshTokens()`
   - Refresh token временно устанавливается в `OpenAPI.TOKEN` для передачи в Authorization header
   - Вызывается `authRefresh()` API endpoint
   - Если успешно - все запросы из очереди повторяются с новым access token
   - Если ошибка - все запросы отклоняются и пользователь разлогинивается через `authStore.logout()`

3. **Повтор оригинального запроса:**
   - После успешного обновления токена оригинальный запрос автоматически повторяется
   - Все запросы из очереди также повторяются с новым токеном
   - Пользователь не замечает перебоя в работе

### Особенности реализации:

- **Предотвращение множественных refresh запросов**: Флаг `isRefreshing` гарантирует, что только один refresh запрос выполняется одновременно
- **Очередь запросов**: `failedQueue` хранит все запросы, которые пришли во время refresh
- **Флаг `_retry`**: Предотвращает бесконечный цикл повторных попыток для одного запроса
- **Передача refresh token**: Refresh token передается через Authorization header (временно подменяется в OpenAPI.TOKEN)

## Использование

Функция вызывается один раз при инициализации приложения в `main.tsx`:

```typescript
import { setupApiInterceptors } from '@/utils/setupApiInterceptors';
import { authStore } from '@/stores/AuthStore';

setupApiInterceptors(authStore);
```

После этого все HTTP запросы через axios будут автоматически обрабатываться перехватчиком.

## Пример сценария

### Успешное обновление токена:

1. Пользователь авторизован, access token истек
2. Делается запрос `GET /api/bookings` → получаем 401
3. Interceptor перехватывает ошибку
4. Автоматически вызывается `authStore.refreshTokens()`
5. Получен новый access token
6. Оригинальный запрос `GET /api/bookings` повторяется с новым токеном
7. Пользователь получает данные, не заметив перебоя

### Неуспешное обновление токена:

1. Пользователь авторизован, но refresh token истек
2. Делается запрос `GET /api/bookings` → получаем 401
3. Interceptor перехватывает ошибку
4. Автоматически вызывается `authStore.refreshTokens()`
5. Refresh endpoint возвращает 401 (refresh token недействителен)
6. `authStore.logout()` вызывается автоматически
7. Пользователь перенаправляется на страницу авторизации

## Изменения в коде

### 1. Новый файл: `src/utils/setupApiInterceptors.ts`
Содержит логику axios interceptor для обработки 401 ошибок

### 2. Изменения в `src/stores/AuthStore.ts`
- Метод `refreshTokens()` теперь:
  - Проверяет наличие `refreshToken` вместо `accessToken`
  - Временно устанавливает refresh token в `OpenAPI.TOKEN` перед запросом
  - Пробрасывает ошибку дальше для interceptor
  - Вызывает `logout()` при ошибке

### 3. Изменения в `src/main.tsx`
- Добавлен вызов `setupApiInterceptors(authStore)` при инициализации

## Связанные файлы

- `src/utils/setupApiInterceptors.ts` - Основная логика interceptor
- `src/stores/AuthStore.ts` - Store с методом `refreshTokens()`
- `src/main.tsx` - Точка инициализации

## Тестирование

Для тестирования логики можно:

1. **Симулировать истечение токена:**
   - В DevTools → Application → Local Storage → удалить `accessToken`
   - Сделать любой API запрос
   - Должен автоматически произойти refresh

2. **Симулировать истечение обоих токенов:**
   - В DevTools → Application → Local Storage → удалить оба токена
   - Сделать любой API запрос
   - Должен произойти автоматический logout и редирект на авторизацию
