# E2E тесты (Playwright)

## Описание

E2E тесты для админ-панели Pro-STO, написанные с использованием [Playwright](https://playwright.dev/).

## Структура

```
e2e/
├── auth.spec.ts      # Тесты авторизации через SMS
├── helpers.ts        # Вспомогательные функции
└── README.md         # Этот файл
```

## Установка

Playwright уже установлен в проекте. Для установки браузеров выполните:

```bash
npx playwright install
```

## Запуск тестов

### Все тесты

```bash
pnpm test:e2e
```

### С UI интерфейсом

```bash
pnpm test:e2e:ui
```

### С отображением браузера (headed mode)

```bash
pnpm test:e2e:headed
```

### Режим отладки

```bash
pnpm test:e2e:debug
```

### Просмотр отчета

```bash
pnpm test:e2e:report
```

### Запуск конкретного теста

```bash
pnpm test:e2e auth.spec.ts
```

### Запуск в конкретном браузере

```bash
pnpm test:e2e --project=chromium
pnpm test:e2e --project=firefox
pnpm test:e2e --project=webkit
```

## Переменные окружения

Настройки для E2E тестов находятся в файле `.env.e2e`:

- `E2E_TEST_PHONE` - тестовый номер телефона (без +7)
- `E2E_TEST_CODE` - тестовый SMS код
- `E2E_BASE_URL` - URL приложения
- `E2E_API_URL` - URL API
- `E2E_TIMEOUT` - таймаут для тестов

## Тесты авторизации (auth.spec.ts)

### Основной сценарий
- ✅ Полный флоу авторизации через SMS
- ✅ Ввод номера телефона
- ✅ Ввод SMS кода
- ✅ Проверка успешного входа
- ✅ Проверка сохранения сессии

### Валидация
- ✅ Ошибка при неполном номере телефона
- ✅ Ошибка при неверном SMS коде
- ✅ Повторная отправка кода

### Навигация
- ✅ Редирект на логин при доступе к защищенным страницам
- ✅ Обработка Enter на форме ввода телефона

## Настройка бэкенда для тестов

Для корректной работы E2E тестов необходимо настроить тестовое окружение на бэкенде:

1. Создать тестовый номер телефона `+79999999999`
2. Настроить фиксированный код `1234` для этого номера
3. Отключить реальную отправку SMS для тестовых номеров

## Отладка

### Просмотр следа выполнения

При падении теста автоматически создается trace файл. Просмотреть его можно:

```bash
npx playwright show-trace trace.zip
```

### Скриншоты

Скриншоты автоматически создаются при падении тестов и сохраняются в `test-results/`.

### Видео

Для записи видео добавьте в `playwright.config.ts`:

```typescript
use: {
  video: 'on-first-retry',
}
```

## CI/CD

В CI окружении тесты запускаются с дополнительными настройками:
- 2 повтора при падении
- 1 воркер (последовательное выполнение)
- HTML репортер

## Лучшие практики

1. **Изоляция**: Каждый тест должен быть независимым
2. **Очистка**: Используйте `beforeEach` для очистки данных
3. **Ожидания**: Используйте `expect` вместо `waitFor` где возможно
4. **Селекторы**: Предпочитайте role-based селекторы и data-testid
5. **Вспомогательные функции**: Используйте helpers.ts для общей логики

## Полезные ссылки

- [Playwright Documentation](https://playwright.dev/docs/intro)
- [Best Practices](https://playwright.dev/docs/best-practices)
- [API Reference](https://playwright.dev/docs/api/class-playwright)
